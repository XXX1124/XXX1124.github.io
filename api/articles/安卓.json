{"title":"安卓V/AB架构的详细分析","uid":"1a92f1a6234cdd3e6297361a0fe26ab2","slug":"安卓","date":"2023-07-17T11:20:25.000Z","updated":"2023-07-17T11:26:16.743Z","comments":true,"path":"api/articles/安卓.json","keywords":null,"cover":"https://www.helloimg.com/images/2023/07/17/oAnFCY.jpg","content":"<div class=\"custom-quote tip\">\n<span class=\"custom-quote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06\"></path>\n<path stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M11.99 18H12.01\"></path>\n</svg></span>\n<p class=\"custom-quote-title\">安卓分区架构发展阶段</p>\n<p>onlyA→A&#x2F;B→onlyA动态分区→AB动态分区→V&#x2F;AB</p>\n</div>\n<h1 id=\"安卓分区的发展\"><a href=\"#安卓分区的发展\" class=\"headerlink\" title=\"安卓分区的发展\"></a>安卓分区的发展</h1><p>在安卓11上，谷歌又研究出了个新玩法：VAB架构(又称虚拟AB分区)，而出厂安卓11以上的新机型，几乎都是VAB架构，似乎是谷歌强制要求的。本章的目的是，分享我所学习、了解、熟悉到的VAB架构，分享给大家，让各位机友在玩机路上尽量少走弯路、少跑没必要的售后一日游。本章可能需要一定的玩机知识及经验，如果你看不太懂的话，说明你暂时可能还不会遇到这些问题。好了，废话不多说，我们分析VAB架构之前，我们先来了解一下安卓分区架构历年的发展，如下表格</p>\n<details class=\"custom-details\">\n<summary>点我展开表格</summary>\n<p><strong>onlyA分区</strong></p>\n<table>\n<thead>\n<tr>\n<th>onlya架构(小米九)</th>\n<th>分区名</th>\n<th>逻辑分区</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>分区一</td>\n<td>system</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区二</td>\n<td>vendor</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区三</td>\n<td>boot</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区四</td>\n<td>dtbo</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区五</td>\n<td>recovery</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区六</td>\n<td>userdata</td>\n<td>-</td>\n</tr>\n<tr>\n<td>……</td>\n<td>……</td>\n<td>……</td>\n</tr>\n</tbody></table>\n<p><strong>A&#x2F;B分区</strong></p>\n<table>\n<thead>\n<tr>\n<th>A&#x2F;B架构 (一加7pro)</th>\n<th>分区名</th>\n<th>逻辑分区</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>分区一</td>\n<td>system_a</td>\n<td></td>\n</tr>\n<tr>\n<td>分区二</td>\n<td>system_b</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区三</td>\n<td>vendor_a</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区四</td>\n<td>vendor_b</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区五</td>\n<td>boot_a</td>\n<td>-</td>\n</tr>\n<tr>\n<td>分区六</td>\n<td>boot_b</td>\n<td>-</td>\n</tr>\n<tr>\n<td>……</td>\n<td>……</td>\n<td>……</td>\n</tr>\n</tbody></table>\n<p><strong>onlyA动态分区</strong></p>\n<table>\n<thead>\n<tr>\n<th>onlyA动态分区(小米10)</th>\n<th>分区名</th>\n<th>逻辑分区</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>分区一</td>\n<td>super</td>\n<td>system</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>vendor</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>odm</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>product</td>\n</tr>\n<tr>\n<td>分区二</td>\n<td>boot</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区三</td>\n<td>dtbo</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区四</td>\n<td>recovery</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区五</td>\n<td>userdata</td>\n<td>……</td>\n</tr>\n<tr>\n<td>……</td>\n<td>……</td>\n<td>……</td>\n</tr>\n</tbody></table>\n<p><strong>AB动态分区</strong></p>\n<table>\n<thead>\n<tr>\n<th>AB动态(一加八)</th>\n<th>分区</th>\n<th>逻辑分区</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>分区一</td>\n<td>super</td>\n<td>system_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>vendor_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>odm_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>product_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>system_b</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>vendor_b</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>odm_b</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>product_b</td>\n</tr>\n<tr>\n<td>分区二</td>\n<td>boot_a</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区三</td>\n<td>boot_b</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区四</td>\n<td>dtbo_a</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区五</td>\n<td>dtbo_b</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区六</td>\n<td>userdata</td>\n<td>……</td>\n</tr>\n<tr>\n<td>……</td>\n<td>……</td>\n<td>……</td>\n</tr>\n</tbody></table>\n<p><strong>vab分区</strong></p>\n<table>\n<thead>\n<tr>\n<th>vab分区</th>\n<th>分区名</th>\n<th>逻辑分区</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>分区一</td>\n<td>super</td>\n<td>system_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>vendor_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>odm_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>product_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>system_ext_a</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>system_b</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>vendor_b</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>odm_b</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>product_b</td>\n</tr>\n<tr>\n<td>分区一</td>\n<td>super</td>\n<td>system_ext_b</td>\n</tr>\n<tr>\n<td>分区二</td>\n<td>boot_a</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区三</td>\n<td>boot_b</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区四</td>\n<td>vendor_boot_a</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区五</td>\n<td>vendor_boot_b</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区六</td>\n<td>dtbo_a</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区七</td>\n<td>dtbo_b</td>\n<td>……</td>\n</tr>\n<tr>\n<td>分区八</td>\n<td>userdata</td>\n<td>……</td>\n</tr>\n<tr>\n<td>……</td>\n<td>……</td>\n<td>……</td>\n</tr>\n</tbody></table>\n\n</details>\n<h1 id=\"什么是vab架构\"><a href=\"#什么是vab架构\" class=\"headerlink\" title=\"什么是vab架构\"></a>什么是vab架构</h1><p>所谓的VAB架构，其实就是AB分区，套上了动态分区，再解决了AB分区的空间占用问题。上面的表格中，我列举了一些，刷机时经常会刷写的分区(system,vendor,boot,recovery等等)。userdata分区就是用户分区，格式化data就是格式化的这个分区。需要注意的是，格式化data和清空data，是两个不同的概念，经常会有小白把这两个概念搞混淆。格式化data就是把userdata的分区进行格式化操作，就像你格式化U盘一样，是格式化操作。而清空data，是删除data分区的所有文件及文件夹。当你遇到data挂载不上时，你清空data是没有效果的，这个时候，你需要进行格式化data操作，才能挂载data，所以，这两个不要搞混淆了。</p>\n<h1 id=\"AB和VAB的相似之处\"><a href=\"#AB和VAB的相似之处\" class=\"headerlink\" title=\"AB和VAB的相似之处\"></a>AB和VAB的相似之处</h1><p>的确很相似，我刚开始接触VAB的时候，也被这个现象给欺骗了，以为VAB和AB的动态分区架构基本一致，但实际上，差别太大了。仔细一点，不难看出，AB的动态分区架构，和VAB架构的不同点有两处：一是VAB架构的逻辑分区中多了两个【system_ext_a】和【system_ext_b】；<br>VAB架构中的【system_b】、【vendor_b】、【odm_b】、【product_b】、【system_ext_b】都不是真实存在的。什么意思呢？意思就是说，不管你使用A分区，还是B分区，在挂载系统的时候，逻辑分区里面，都是挂载的_a，而不会挂载_b。是不是有点难于理解？AB的的动态分区架构中，逻辑分区里面，不管是system_a还是system_b，都是可以刷写img镜像文件的，是真实存在的，有空间大小的AB分区来回切换的时候，system_a和system_b就会被来回切换着挂载到根目录而VAB架构呢？system_a是有空间大小的，但是system_b是没有分配空间大小的(空间占用0字节)。不管你切换到A分区，还是切换到B分区，它都只会挂载system_a。这个system_b不会被使用。具体它是怎么挂载的呢，我也说不清楚，谷歌开发者文档中也没有太多的介绍，我目前是按照我自己的刷机知识及经验推论出来的，不保证是100%正确。</p>\n<h2 id=\"以上总结\"><a href=\"#以上总结\" class=\"headerlink\" title=\"以上总结\"></a>以上总结</h2><ol>\n<li>A分区时，挂载system_a，并使用所有的_a分区。</li>\n<li>B分区时，将system_a重命名为system_b，同时0字节大小的system_b也重命名为system_a，挂载重命名后的system_b，并使用所有的_b分区。</li>\n<li>在系统内OTA更新时(假设当前是处于A分区，更新成功后为切换到B分区)，需要更新的系统补丁包，解压后存放在data分区，复制一份system_a，并重命名为system_b_tmp，放到data分区的某个隐藏目录中，将下载好的系统更新包，整合进复制出来的system_b_tmp，得到更新完整包system_b_tmp，重启手机，如果成功挂载system_b_tmp，那么就把system_b_tmp替换掉动态分区的system_a，并重命名为system_b，原本0字节的system_b重命名为system_a，并切换至b分区。更新完成。如果system_b_tmp更新失败，则不会动原有的分区，system_a分区依然原样<br>4..VAB架构有点不太好解释，它其实和AB分区类似，有两套完整的A和B，但是在动态分区的super分区中，system,vendor等这种逻辑分区，却不像AB那样有两套，<br>VAB它只有一套，<br>VAB它只有一套，<br>VAB它只有一套，<br>VAB它只有一套，<br>VAB它只有一套，<br>VAB它只有一套，切换分区时，就是那一套在不断的重命名分区名而已(谷歌觉得这样能更节省空间)，这样理解就容易多了。所以，用上所述，VAB架构，不能像AB那样玩。AB分区的可以，一个A分区坏了，切换到B分区继续用。而VAB分区的话，一个A分区坏了，切换到B分区也不能继续用，因为system,vendor等这几个重要的逻辑分区，还是使用的同一个。对于VAB架构的机型来说，不要试图随便玩，因为一个分区坏了，另一个分区也是坏的</li>\n</ol>\n<h1 id=\"vab分区的rec问题\"><a href=\"#vab分区的rec问题\" class=\"headerlink\" title=\"vab分区的rec问题\"></a>vab分区的rec问题</h1><p>在vab架构中没有rec分区，不要试图使用命令【fastboot flash recovery twrp.img】来刷写twrp，没有任何效果的。<br>那么既然没有rec分区，那么官方是如何在rec中更新系统的呢？答：recovery分区，被合并到了boot分区中，所以其实还是可以用rec来更新系统的。不过，我们先来讲讲boot.img包含哪些东西：<br>一个完整的boot.img，它和这几个分区是一套的：<br>boot(linux内核存放分区),<br>dtbo(屏幕刷新率控制分区),<br>recovery(小型恢复系统分区)。<br>而这三个，在安卓11以前，都是的分别的三个不同分区，其实都是boot.img拆分出来的，被分成了3份。</p>\n<p>而到安卓11的时候，boot.img，里面包含了一个Linux内核【Kernel】，一个小型恢复系统【ramdisk】。但是，在这个Liunx内核中，部分配置文件又被从Kernel中，分离出来，变成了一个全新的分区【vendor_boot】，也就是说，安卓11的时候，一个完整的boot.img，变成了这几个分区：<br>boot(linux内核存放分区),<br>dtbo(屏幕刷新率控制分区),<br>vendor_boot(Linux内核中的部分配置文件)</p>\n<p>是不是发现，没有recovery分区了？其实，它被合并到了boot分区中。说白了，twrp.img它即是boot也是recovery。也就是说，boot分区里面有两个东西：一个是Linux内核【Kernel】，一个是小型恢复系统【ramdisk】。当我们进入rec时，就是启动的【ramdisk】，当我们开机进入桌面时，就是启动的【Kernel】。所以说，【fastboot flash recovery twrp.img】来刷写twrp，没有任何效果的。要刷twrp，是要刷进boot分区的。即：【fastboot flash boot twrp.img】</p>\n<p>但是，你以为这就完了吗？你要是真把twrp.img刷进boot分区，那么恭喜你，成功把手机刷砖了为啥呢？不要急，先喝杯水，听我继续慢慢道来。前面说到了，一个VAB架构的boot.img，包含两个东西：Kernel和ramdisk，其中，ramdisk就是rec，Kernel就是内核。(注意ramdisk是需要Kernel来引导它启动的)<br>而Kernel和你当前的系统，还有dtbo,vendor_boot，是配套存在的，它们之前必须要配套，不配套可能有BUG(比如wifi打不开，蓝牙没声音等等)，或者直接无法开机。<br>而twrp.img呢，它里面也是有一个Kernel和ramdisk的，说白了，twrp.img它即是boot也是recovery。刷进boot分区，相当于你同时刷了内核Kernel和小型恢复系统ramdisk。所以，你要刷rec，不能将rec刷进boot分区。<br>你要刷rec，不能将rec刷进boot分区。<br>你要刷rec，不能将rec刷进boot分区。<br>你要刷rec，不能将rec刷进boot分区。<br>你要刷rec，不能将rec刷进boot分区。</p>\n<p>那么，twrp的正确安装原理是什么呢？<br>看下面：<br>1、首先，一个twrp.img包含：Kernel和ramdisk。<br>2、其次，一个boot.img包含：Kernel和ramdisk。<br>3、将twrp.img中的ramdisk，替换进boot分区，覆盖掉boot分区中的ramdisk。</p>\n<p>这就是正确的安装twrp方式。说人话：<br>在fastboot中，临时加载twrp，然后就进入rec了，这个时候的boot分区并没有被刷写，所以叫做临时加载。在rec的高级中，点击安装twrp，它就会把rec中的ramdisk替换掉boot分区中的ramdisk，然后，安装完成。</p>\n<p><strong>好了，本次玩机分享就到这里，希望各位机友在玩机路上少走弯路。</strong></p>\n","feature":true,"text":" 安卓分区架构发展阶段 onlyA→A&#x2F;B→onlyA动态分区→AB动态分区→V&#x2F;AB 安卓分区的发展在安卓11上，谷歌又研究出了个新玩法：VAB架构(又称虚拟AB分区)，而出厂安卓11以上的新机型，几乎都是VAB架构，似乎是谷歌强制要求的。本章的目的是，分享...","link":"","photos":[],"count_time":{"symbolsCount":"4.7k","symbolsTime":"4 mins."},"categories":[],"tags":[{"name":"安卓玩机","slug":"安卓玩机","count":1,"path":"api/tags/安卓玩机.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E5%AE%89%E5%8D%93%E5%88%86%E5%8C%BA%E7%9A%84%E5%8F%91%E5%B1%95\"><span class=\"toc-text\">安卓分区的发展</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BB%80%E4%B9%88%E6%98%AFvab%E6%9E%B6%E6%9E%84\"><span class=\"toc-text\">什么是vab架构</span></a></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#AB%E5%92%8CVAB%E7%9A%84%E7%9B%B8%E4%BC%BC%E4%B9%8B%E5%A4%84\"><span class=\"toc-text\">AB和VAB的相似之处</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BB%A5%E4%B8%8A%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">以上总结</span></a></li></ol></li><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#vab%E5%88%86%E5%8C%BA%E7%9A%84rec%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">vab分区的rec问题</span></a></li></ol>","author":{"name":"花未眠","slug":"blog-author","avatar":"https://www.helloimg.com/images/2023/07/10/oAoQOM.jpg","link":"/","description":"你好 世界","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"github开源项目异次元发卡系统","uid":"ffd1598a055561954e2d735eb58f3eb6","slug":"发卡","date":"2023-07-17T21:28:34.046Z","updated":"2023-07-17T21:28:34.046Z","comments":true,"path":"api/articles/发卡.json","keywords":null,"cover":"https://www.helloimg.com/images/2023/07/18/oAH98n.jpg","text":" 环境要求 异次元店铺系统对环境也有一定的要求，但是不限制于只在服务器安装，你可以在虚拟主机以及各种操作系统上都可以完美安装。在安装程序之前，检查你的服务器或者虚拟主机是否支持以下环境： PHP＞&#x3D;8.0Mysql＞&#x3D;5.6 快速体验 后台演示: http:/...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"网站源码","slug":"网站源码","count":1,"path":"api/tags/网站源码.json"},{"name":"网站搭建","slug":"网站搭建","count":1,"path":"api/tags/网站搭建.json"}],"author":{"name":"花未眠","slug":"blog-author","avatar":"https://www.helloimg.com/images/2023/07/10/oAoQOM.jpg","link":"/","description":"你好 世界","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"青龙多客户端部署（Win Linux Android）","uid":"9f57799f3e5bd67964dd376a454447ae","slug":"青龙","date":"2023-07-09T22:30:25.000Z","updated":"2023-07-17T21:08:02.906Z","comments":true,"path":"api/articles/青龙.json","keywords":null,"cover":"https://www.helloimg.com/images/2023/07/11/oA1BSR.jpg","text":"前言 什么是青龙面板？ 青龙面板是支持 Python3、JavaScript、Shell、Typescript 的定时任务管理平台（Timed task management platform supporting Python3, JavaScript, Shell, Type...","link":"","photos":[],"count_time":{"symbolsCount":"2.3k","symbolsTime":"2 mins."},"categories":[],"tags":[{"name":"青龙","slug":"青龙","count":1,"path":"api/tags/青龙.json"},{"name":"docker","slug":"docker","count":1,"path":"api/tags/docker.json"}],"author":{"name":"花未眠","slug":"blog-author","avatar":"https://www.helloimg.com/images/2023/07/10/oAoQOM.jpg","link":"/","description":"你好 世界","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}